<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zone01 Profile</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="app"></div>
<script>
  // API Endpoints
  const ENDPOINTS = {
    signInUrl: "https://learn.zone01oujda.ma/api/auth/signin",
    graphQlUrl: "https://learn.zone01oujda.ma/api/graphql-engine/v1/graphql"
  };
  // GraphQL query string
  const USER_QUERY = `query {
    user {
      login firstName lastName email auditRatio totalUp totalDown
      finished_projects: groups(where: {group: {status: {_eq: finished}, _and: [{path: {_like: "%module%"}}, {path: {_nilike: "%piscine-js%"}}]}}) {
        group { path members { userLogin } }
      }
      transactions_aggregate(where: {eventId: {_eq: 41}, type: {_eq: "xp"}}) {
        aggregate { sum { amount } }
      }
    }
  }`;

  // Global state
  let currentUser = {};
  let collaboratorList = [];
  let authToken = null;

  // Local Storage Token Management
  function storeToken(token) {
    try { localStorage.setItem('zone01_auth_token', token); }
    catch { console.warn('Local storage unavailable'); }
  }
  function fetchToken() {
    try { return localStorage.getItem('zone01_auth_token'); }
    catch { console.warn('Local storage unavailable'); return null; }
  }
  function clearToken() {
    try { localStorage.removeItem('zone01_auth_token'); }
    catch { console.warn('Local storage unavailable'); }
  }

  // JWT validation
  function checkTokenValidity(token) {
    if (!token) return false;
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.exp > Date.now() / 1000;
    } catch {
      return false;
    }
  }

  // Utility to format XP nicely
  function formatExperience(xpValue) {
    if (xpValue < 1000) return xpValue + " XP";
    if (xpValue < 1_000_000) return Math.floor(xpValue / 1000) + " kXP";
    return Math.floor(xpValue / 1_000_000) + " MXP";
  }

  // Render login form
  function renderLoginForm() {
    document.getElementById('app').innerHTML = `
      <div class="card login-box">
        <h1>Zone01 Login</h1>
        <input type="text" id="input-username" placeholder="Username" required />
        <input type="password" id="input-password" placeholder="Password" required />
        <button onclick="submitLogin()">Login</button>
        <div id="login-error" class="error"></div>
      </div>
    `;
  }
  // Login handler
  async function submitLogin() {
    const username = document.getElementById('input-username').value;
    const password = document.getElementById('input-password').value;
    const basicAuth = btoa(`${username}:${password}`);

    try {
      const res = await fetch(ENDPOINTS.signInUrl, {
        method: "POST",
        headers: { Authorization: `Basic ${basicAuth}` }
      });
      if (!res.ok) throw new Error('Auth failed');

      authToken = await res.json();
      storeToken(authToken);
      fetchUserProfile();
    } catch {
      document.getElementById('login-error').textContent = 'Login failed. Please try again.';
    }
  }

  // Fetch user profile and collaborators from GraphQL
  async function fetchUserProfile() {
    try {
      const res = await fetch(ENDPOINTS.graphQlUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`
        },
        body: JSON.stringify({ query: USER_QUERY })
      });
      const data = await res.json();
      if (data.errors) throw new Error('Data fetch error');

      const user = data.data.user[0];
      currentUser = {
        username: user.login,
        firstName: user.firstName,
        lastName: user.lastName,
        email: user.email,
        auditRatio: parseFloat(user.auditRatio).toFixed(1),
        totalUp: user.totalUp,
        totalDown: user.totalDown,
        projects: user.finished_projects,
        xp: formatExperience(user.transactions_aggregate.aggregate.sum.amount)
      };

      collaboratorList = [];
      currentUser.projects.forEach(proj => {
        proj.group.members.forEach(member => {
          if (member.userLogin !== currentUser.username) {
            const existing = collaboratorList.find(c => c.name === member.userLogin);
            if (existing) existing.count++;
            else collaboratorList.push({ name: member.userLogin, count: 1 });
          }
        });
      });

      renderUserProfile();
    } catch {
      renderLoginForm();
    }
  }
  // Display user profile UI
  function renderUserProfile() {
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div class="header">
          <h1>Welcome, ${currentUser.firstName}!</h1>
          <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <div class="profile-grid">
          <section class="info-section">
            <div class="card">
              <h3>Personal Information</h3>
              <div class="stat"><span>Username:</span><span>${currentUser.username}</span></div>
              <div class="stat"><span>Email:</span><span>${currentUser.email}</span></div>
              <div class="stat"><span>XP:</span><span>${currentUser.xp}</span></div>
              <div class="stat"><span>Audit Ratio:</span><span>${currentUser.auditRatio}</span></div>
              <div class="stat"><span>Projects:</span><span>${currentUser.projects.length}</span></div>
            </div>

            <div class="card">
              <h3>Completed Projects</h3>
              <div class="projects">
                ${currentUser.projects.map(p => `<div class="project">${p.group.path.split('/').pop()}</div>`).join('')}
              </div>
            </div>
          </section>

          <section class="chart-section">
            <div class="card">
              <div>
                <h3>Projects Completed</h3>
                <div class="ratio-display" style="color:  #969b9f;">${currentUser.projects.length}</div>
                <div style="text-align:center; color:#666; margin: 10px 0 30px 0;">
                  Total finished projects
                </div>
              </div>
              <div>
                <h3>Collaboration Partners</h3>
                <div id="collab-info" class="chart-info">Hover bars for details</div>
                <div id="collab-chart" class="chart-container" style="height: 200px;"></div>
              </div>
            </div>

            <div class="card">
              <h3>Audit Ratio</h3>
              <div class="ratio-display">${currentUser.auditRatio}</div>
              <div id="audit-ratio-bar" class="ratio-bar"></div>
              <div class="ratio-labels">
                <span style="color: #28a745">Given: ${currentUser.totalUp}</span>
                <span style="color: #dc3545">Received: ${currentUser.totalDown}</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    `;

    renderCollabChart();
    renderAuditChart();
  }

  // Draw the collaboration bar chart SVG
  function renderCollabChart() {
    if (collaboratorList.length === 0) return;

    collaboratorList.sort((a, b) => b.count - a.count);
    const maxCount = collaboratorList[0].count;
    const svgWidth = Math.max(300, collaboratorList.length * 40);

    const svgNS = "http://www.w3.org/2000/svg";
    const svgElem = document.createElementNS(svgNS, "svg");
    svgElem.setAttribute("width", svgWidth);
    svgElem.setAttribute("height", "180");

    collaboratorList.forEach((collab, index) => {
      const barHeight = (collab.count / maxCount) * 140;
      const xPos = index * 35 + 10;
      const yPos = 170 - barHeight;

      const rect = document.createElementNS(svgNS, "rect");
      rect.setAttribute("x", xPos);
      rect.setAttribute("y", yPos);
      rect.setAttribute("width", "25");
      rect.setAttribute("height", barHeight);
      rect.setAttribute("fill", " #969b9f");
      rect.setAttribute("rx", "3");
      rect.classList.add("bar");

      rect.onmouseenter = () => {
        document.getElementById('collab-info').textContent = `${collab.name}: ${collab.count} projects`;
      };
      rect.onmouseleave = () => {
        document.getElementById('collab-info').textContent = 'Hover bars for details';
      };

      svgElem.appendChild(rect);
    });

    const container = document.getElementById('collab-chart');
    container.innerHTML = '';
    container.appendChild(svgElem);
  }

  // Draw the audit ratio SVG bar
  function renderAuditChart() {
    const total = currentUser.totalUp + currentUser.totalDown;
    if (total === 0) return;

    const barWidth = 600;
    const barHeight = 30;
    const greenWidth = (currentUser.totalUp / total) * barWidth;
    const redWidth = (currentUser.totalDown / total) * barWidth;

    const container = document.getElementById('audit-ratio-bar');
    container.innerHTML = '';

    const svgNS = "http://www.w3.org/2000/svg";
    const svgElem = document.createElementNS(svgNS, "svg");
    svgElem.setAttribute("width", barWidth);
    svgElem.setAttribute("height", barHeight);
    svgElem.style.border = "1px solid #ccc";
    svgElem.style.borderRadius = "5px";

    const greenRect = document.createElementNS(svgNS, "rect");
    greenRect.setAttribute("x", 0);
    greenRect.setAttribute("y", 0);
    greenRect.setAttribute("width", greenWidth);
    greenRect.setAttribute("height", barHeight);
    greenRect.setAttribute("fill", "#28a745");

    const redRect = document.createElementNS(svgNS, "rect");
    redRect.setAttribute("x", greenWidth);
    redRect.setAttribute("y", 0);
    redRect.setAttribute("width", redWidth);
    redRect.setAttribute("height", barHeight);
    redRect.setAttribute("fill", "#dc3545");

    svgElem.appendChild(greenRect);
    svgElem.appendChild(redRect);

    container.appendChild(svgElem);
  }

  // Logout function
  function handleLogout() {
    authToken = null;
    clearToken();
    renderLoginForm();
  }

  // Initialize app on page load
  function initializeApp() {
    const saved = fetchToken();
    if (saved && checkTokenValidity(saved)) {
      authToken = saved;
      fetchUserProfile();
    } else {
      clearToken();
      renderLoginForm();
    }
  }

  // Start
  initializeApp();
</script>
</body>
</html>
